<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ | THE SCENERY VINTAGE FARM</title>

<link rel="manifest" href="/TRO/manifest.json">
<meta name="theme-color" content="#111111">

<style>
*{box-sizing:border-box}
body{margin:0;background:#f0f1f3;font-family:Segoe UI,Tahoma,sans-serif;color:#222}
.page{max-width:1800px;margin:32px auto;background:#fff;padding:32px 36px;border-radius:16px}
.header{display:flex;justify-content:space-between;align-items:flex-end;border-bottom:1px solid #d6d9de;padding-bottom:16px}
.header-left h1{margin:0;font-size:28px}
.header-left h2{margin:4px 0 0;font-size:16px;color:#666}
.header-right{display:flex;gap:20px}
label{font-size:12px;font-weight:600;color:#555}
input,textarea{width:100%;padding:6px 8px;border:1px solid #d1d5db;border-radius:8px;font-size:12px}
textarea{resize:vertical}
.card{margin-top:24px;background:#fafafa;padding:20px;border-radius:16px}
table{width:100%;border-collapse:collapse;font-size:12px}
th{background:#2f2f2f;color:#fff;padding:8px}
td{padding:6px;border-bottom:1px solid #e5e7eb;vertical-align:top}
.btn{padding:8px 18px;border-radius:12px;font-weight:600;border:none;cursor:pointer}
.btn.add{background:#e6e8ec}
.btn-del{background:#fee2e2;border:none;border-radius:8px;padding:4px 8px;cursor:pointer}
.actions{margin-top:20px;display:flex;justify-content:space-between;align-items:center;gap:16px}
.img-box{width:130px;height:130px;border:2px dashed #94a3b8;border-radius:12px;display:flex;align-items:center;justify-content:center;cursor:pointer;overflow:hidden;background:#fff}
.img-box img{width:100%;height:100%;object-fit:cover}
.img-hint{font-size:11px;color:#64748b;text-align:center}
.sub-row td{background:#f9fafb}
.sub-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}

/* popup */
.popup-backdrop{
  position:fixed;inset:0;
  background:rgba(0,0,0,.45);
  backdrop-filter:blur(2px);
  display:none;align-items:center;justify-content:center;
  z-index:3000;
}
.popup{
  background:#fff;border-radius:18px;
  padding:24px;width:360px;text-align:center;
  transform:translateY(20px) scale(.95);
  opacity:0;transition:.25s ease;
}
.popup.show{transform:none;opacity:1}
.popup-actions{display:flex;gap:10px;justify-content:center;margin-top:18px}
.popup .danger{background:#dc2626;color:#fff}
.popup .primary{background:#2563eb;color:#fff}
.popup .ghost{background:#e5e7eb}

@media print{button,.btn-del,#installBtn{display:none!important}}
</style>
</head>
<body>

<div class="page">
  <div class="header">
    <div class="header-left">
      <h1>‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h1>
      <h2>THE SCENERY VINTAGE FARM</h2>
    </div>
    <div class="header-right">
      <div><label>‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</label><input type="month" id="monthPicker"></div>
      <div><label>‡πÅ‡∏ú‡∏ô‡∏Å</label><input type="text" id="deptInput"></div>
    </div>
  </div>

  <div class="card">
    <table>
      <thead>
        <tr>
          <th>#</th><th>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</th><th>‡∏£‡∏π‡∏õ</th><th>‡∏´‡∏ô‡πà‡∏ß‡∏¢</th>
          <th>‡∏™‡∏ï‡πá‡∏≠‡∏Å</th><th>‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</th><th>‡∏ã‡∏∑‡πâ‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°</th>
          <th>‡∏£‡∏≤‡∏Ñ‡∏≤</th><th>‡∏£‡∏ß‡∏°</th><th>‡∏£‡πâ‡∏≤‡∏ô</th><th>‡∏•‡∏ö</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
    <button class="btn add" onclick="addRow()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
  </div>

  <div class="actions">
    <strong>‡∏£‡∏ß‡∏° <span id="grand">0.00</span> ‡∏ö‡∏≤‡∏ó</strong>
    <div>
      <button class="btn add" id="installBtn" style="display:none">‚¨áÔ∏è ‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏≠‡∏õ</button>
      <button class="btn add" onclick="exportData()">üíæ ‡πÄ‡∏ã‡∏ü‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
      <button class="btn add" onclick="importData()">üìÇ ‡∏Å‡∏π‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
      <input type="file" id="importFile" accept=".json" hidden>
      <button class="btn" onclick="window.print()">üñ® ‡∏û‡∏¥‡∏°‡∏û‡πå / Save PDF</button>
    </div>
  </div>
</div>

<!-- popup -->
<div class="popup-backdrop" id="popup">
  <div class="popup" id="popupBox">
    <h3 id="popupTitle"></h3>
    <p id="popupMsg"></p>
    <div class="popup-actions" id="popupActions"></div>
  </div>
</div>

<script>
/* popup */
function showPopup({title,msg,actions=[]}){
  popupTitle.innerText=title;
  popupMsg.innerText=msg||'';
  popupActions.innerHTML='';
  actions.forEach(a=>{
    const b=document.createElement('button');
    b.className='btn '+(a.type||'ghost');
    b.innerText=a.label;
    b.onclick=()=>{closePopup();a.onClick&&a.onClick()};
    popupActions.appendChild(b);
  });
  popup.style.display='flex';
  requestAnimationFrame(()=>popupBox.classList.add('show'));
}
function closePopup(){
  popupBox.classList.remove('show');
  setTimeout(()=>popup.style.display='none',200);
}

/* PWA install */
let deferredPrompt;
const installBtn=document.getElementById('installBtn');
window.addEventListener('beforeinstallprompt',e=>{
  e.preventDefault();
  deferredPrompt=e;
  installBtn.style.display='inline-block';
});
installBtn.onclick=async()=>{
  if(!deferredPrompt) return;
  deferredPrompt.prompt();
  await deferredPrompt.userChoice;
  installBtn.style.display='none';
};
if('serviceWorker'in navigator){
  navigator.serviceWorker.register('/TRO/sw.js');
}

/* IndexedDB for images */
let db;
const dbReq=indexedDB.open('PO_IMAGES',1);
dbReq.onupgradeneeded=e=>{
  db=e.target.result;
  db.createObjectStore('images',{keyPath:'id'});
};
dbReq.onsuccess=e=>db=e.target.result;

/* logic */
const monthPicker=document.getElementById('monthPicker');
const deptInput=document.getElementById('deptInput');
const tbody=document.getElementById('tbody');

monthPicker.onchange=loadMonth;
deptInput.oninput=saveMonth;

function addRow(d={}){
  if(!monthPicker.value){
    showPopup({title:'‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô',msg:'‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£'});
    return;
  }

  const rowId=d.id||crypto.randomUUID();
  const m=document.createElement('tr');
  m.dataset.id=rowId;
  const s=document.createElement('tr'); s.className='sub-row';

  m.innerHTML=`
    <td class="no"></td>
    <td><textarea>${d.desc||''}</textarea></td>
    <td><div class="img-box"><span class="img-hint">‡πÅ‡∏ô‡∏ö‡∏£‡∏π‡∏õ</span><input type="file" hidden></div></td>
    <td><input value="${d.unit||''}"></td>
    <td><input type="number" value="${d.stock||''}"></td>
    <td><input type="text" value="${d.remain||''}"></td>
    <td><input type="number" class="buy" value="${d.buy||0}"></td>
    <td><input type="number" class="price" value="${d.price||0}"></td>
    <td class="sum">0.00</td>
    <td><input value="${d.vendor||''}"></td>
    <td><button class="btn-del">üóë</button></td>`;

  s.innerHTML=`
    <td colspan="11">
      <div class="sub-grid">
        <div><label>‡∏à‡∏∏‡∏î‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå</label><textarea>${d.purpose||''}</textarea></div>
        <div><label>‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</label><textarea>${d.location||''}</textarea></div>
      </div>
    </td>`;

  tbody.append(m,s);
  bindRow(m,s);
  renumber(); calcAll(); saveMonth();
}

function bindRow(m,s){
  [...m.querySelectorAll('input,textarea'),...s.querySelectorAll('textarea')]
    .forEach(e=>e.oninput=()=>{calcAll();saveMonth();});

  const rowId=m.dataset.id;
  const box=m.querySelector('.img-box');
  const input=box.querySelector('input');

  const tx=db.transaction('images','readonly');
  tx.objectStore('images').get(rowId).onsuccess=e=>{
    if(e.target.result){
      box.innerHTML=`<img src="${e.target.result.data}"><input type="file" hidden>`;
      bindRow(m,s);
    }
  };

  box.onclick=()=>input.click();
  input.onchange=()=>{
    const f=input.files[0];
    if(!f) return;
    const r=new FileReader();
    r.onload=()=>{
      db.transaction('images','readwrite').objectStore('images').put({id:rowId,data:r.result});
      box.innerHTML=`<img src="${r.result}"><input type="file" hidden>`;
      bindRow(m,s);
    };
    r.readAsDataURL(f);
  };

  m.querySelector('.btn-del').onclick=()=>{
    showPopup({
      title:'‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö',
      msg:'‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà',
      actions:[
        {label:'‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'},
        {label:'‡∏•‡∏ö',type:'danger',onClick:()=>{
          m.nextSibling.remove(); m.remove();
          renumber(); calcAll(); saveMonth();
        }}
      ]
    });
  };
}

function renumber(){let i=1;tbody.querySelectorAll('.no').forEach(n=>n.innerText=i++)}
function calcAll(){
  let g=0;
  tbody.querySelectorAll('.buy').forEach(b=>{
    const tr=b.closest('tr');
    const s=(b.value*tr.querySelector('.price').value||0).toFixed(2);
    tr.querySelector('.sum').innerText=s;
    g+=+s;
  });
  grand.innerText=g.toFixed(2);
}

function saveMonth(){
  if(!monthPicker.value) return;
  const rows=[]; const trs=[...tbody.children];
  for(let i=0;i<trs.length;i+=2){
    const m=trs[i], s=trs[i+1];
    rows.push({
      id:m.dataset.id,
      desc:m.children[1].querySelector('textarea').value,
      unit:m.children[3].querySelector('input').value,
      stock:m.children[4].querySelector('input').value,
      remain:m.children[5].querySelector('input').value,
      buy:m.children[6].querySelector('input').value,
      price:m.children[7].querySelector('input').value,
      vendor:m.children[9].querySelector('input').value,
      purpose:s.querySelectorAll('textarea')[0].value,
      location:s.querySelectorAll('textarea')[1].value
    });
  }
  localStorage.setItem('PO_'+monthPicker.value,JSON.stringify({dept:deptInput.value,rows}));
}

function loadMonth(){
  tbody.innerHTML='';
  const r=localStorage.getItem('PO_'+monthPicker.value);
  if(!r){addRow();return;}
  const d=JSON.parse(r);
  deptInput.value=d.dept||'';
  d.rows.forEach(addRow);
}

function exportData(){
  const data=localStorage.getItem('PO_'+monthPicker.value);
  if(!data) return showPopup({title:'‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',msg:'‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡πÄ‡∏ã‡∏ü'});
  const blob=new Blob([data],{type:'application/json'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download='PO_'+monthPicker.value+'.json';
  a.click();
}

function importData(){
  document.getElementById('importFile').click();
}
document.getElementById('importFile').onchange=e=>{
  const f=e.target.files[0];
  if(!f) return;
  const r=new FileReader();
  r.onload=()=>{
    localStorage.setItem('PO_'+monthPicker.value,r.result);
    loadMonth();
    showPopup({title:'‡∏Å‡∏π‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'});
  };
  r.readAsText(f);
};

addRow();
</script>
</body>
</html>
